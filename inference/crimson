#!/usr/bin/env node


/**
 * Inference pipeline CLI wrapper.
 *
 *  @ Aaron Baw 2018
 */

const args = require('commander');
const bundle = require('./modules/bundle');
const package = require('./package.json');
const detectPrimitives = require('./modules/detectPrimitives');
const {generateCode, generateACR } = require('./modules/generateCode');
const filterPrimitives = require('./modules/filterPrimitives');
const fs = require('fs');
const { resolve, basename } = require('path');
const mkdir = require('mkdirp');
// const exec = require('util').promisify(require('child_process').exec);
const {exec} = require('child_process');
// const generator = require('generator');

// Parse arguments.
args
  .version(package.version)
  .usage("--image <image path> --output [output directory] [--context , --project]")
  .option('-i, --image <image path>', 'Source image.')
  .option('-o, --output [output path]', 'Output directory.', './output')
  .option('-c, --context [vanilla, bootstrap, react]', 'Context type ("vanilla", "bootstrap", "react")', 'vanilla')
  .option('-p, --project [static, server]', 'Output type ("static", "server")', 'server')
  .parse(process.argv)

if (!args.image) return args.help();
var imagePath = args.image;
imagePath = resolve(__dirname, imagePath);
const file = imagePath.split('/')[imagePath.split('/').length - 1]
const fileName = file.split('.')[0].substring(0, file.split('.')[0].length);
const outputDir = resolve(__dirname, args.output, fileName);

// Create output directory.
mkdir.sync(outputDir);

// Generate the ACR JSON file, and return the path of the generated file.
// Any changes made by the user will be made to this file using the interactive
// platform.
detectPrimitives(imagePath).then(async primitives => {

  log(`Generating ACR for`, fileName);
  var ACR = generateACR(primitives);
  var outputFilePath = resolve(outputDir,'acr.json')
  fs.writeFileSync(outputFilePath, JSON.stringify(ACR, null, 2));

  log(`Generated ACR.`);

  // Return the path of the ACR file generated.
  return outputFilePath;

}).then(async acrFilePath => {

  log(`Loading ACR file for`, fileName);

  // Load primitives from ACR file.
  var primitives = JSON.parse(fs.readFileSync(acrFilePath));

  log(`Loaded.`);


  log(`Filtering unused primitives.`);
  // Filter leftover primitives which have been used for inference but should not
  // be embedded as code.
  primitives = filterPrimitives(primitives);

  log(`Generating code for`, fileName);

  var code = await generateCode(primitives);


  var HTMLOutput = `
  <!-- Skeleton Code generated below via CRIMSON prototyping tool ${package.version} -->
  <!-- Tool available at ${package.homepage} -->
  <!-- Copyright @ Aaron Baw 2018 -->
  <!DOCTYPE html>
  <html>
    <head>

      <!-- Metadata -->
      <meta source-filename="${file}" />
      <meta source-path="${imagePath}" />
      <meta context="${args.context}" />
      <meta output-type="${args.project}" />

      <title>${fileName[0].toUpperCase() + fileName.substring(1, fileName.length)}</title>

      <!-- CSS -->
      <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" />
      <link rel="stylesheet" type="text/css" href="style.css" />
    </head>
    <body>
    \t${code}

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    </body>
  </html>`

  log(`Generated Code.`);
  log(`Bundling project and saving output to`, outputDir);
  await bundle({outputDir, context: args.context, targets: {source: HTMLOutput, name: 'index.html'}});

  // Run parcel-bundler in output dir.
  if (args.project == 'server'){
    log(`Running parcel-bundler.`, resolve(__dirname, 'node_modules/parcel-bundler/bin/cli.js') + ' ' + resolve(outputDir, 'index.html') + ' -d ' + resolve(outputDir, 'dist'));
    exec(
      resolve(__dirname, 'node_modules/parcel-bundler/bin/cli.js') +
      ' ' +
      resolve(outputDir, 'index.html') +
      ' -d ' +
      resolve(outputDir, 'dist')
    ).stdout.pipe(process.stdout);
  }

})

.catch(console.err);


// Logging.
function log(...msg){
  if (process.env.DEBUG) console.log(basename(__filename.split('.')[0]).toUpperCase(), '|', ...msg);
}
